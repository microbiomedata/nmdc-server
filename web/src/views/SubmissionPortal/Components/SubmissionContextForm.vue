<script lang="ts">
import {
  defineComponent,
  ref,
  onMounted,
  watch,
  nextTick,
} from '@vue/composition-api';
// @ts-ignore
import NmdcSchema from 'nmdc-schema/nmdc_schema/nmdc_materialized_patterns.yaml';
import Definitions from '@/definitions';
import {
  contextForm,
  contextFormValid,
  AwardTypes,
  addressFormValid,
  canEditSubmissionMetadata,
} from '../store';
import SubmissionContextShippingForm from './SubmissionContextShippingForm.vue';
import SubmissionDocsLink from './SubmissionDocsLink.vue';
import SubmissionPermissionBanner from './SubmissionPermissionBanner.vue';

export default defineComponent({
  components: { SubmissionContextShippingForm, SubmissionDocsLink, SubmissionPermissionBanner },
  setup() {
    const formRef = ref();
    const facilityEnum = Object.keys(NmdcSchema.enums.ProcessingInstitutionEnum.permissible_values).filter(
      (facility: string) => ['EMSL', 'JGI'].includes(facility),
    );
    const projectAwardValidationRules = () => [(v: string) => {
      const awardTypes = Object.values(AwardTypes) as string[];
      const awardChosen = awardTypes.includes(v) || v === contextForm.otherAward;
      const valid = awardChosen || contextForm.facilities.length === 0;
      return valid || 'If submitting to a use facility, this field is required.';
    }];
    const otherAwardValidationRules = () => [(v: string) => {
      const awardTypes = Object.values(AwardTypes) as string[];
      if (contextForm.award && awardTypes.includes(contextForm.award)) {
        return true;
      }
      const inputEmpty = v.trim().length === 0;
      if (contextForm.facilities.length > 0) {
        return !inputEmpty || 'Please enter the kind of project award.';
      }
      return true;
    }];
    const doiRequiredRules = () => [(v: string) => {
      const valid = !!v || (!contextForm.facilityGenerated && contextForm.dataGenerated) || (contextForm.unknownDOI && !contextForm.dataGenerated);
      return valid || 'An award DOI is required if data was or is going to be generated by a DOE facility.';
    }];
    const revalidate = () => {
      nextTick(() => formRef.value.validate());
    };

    function addAwardDoi() {
      if (contextForm.awardDois === null || contextForm.awardDois.length === 0) {
        contextForm.awardDois = [''];
      } else {
        contextForm.awardDois.push('');
      }
    }

    function removeAwardDoi(i: number) {
      if (contextForm.awardDois === null) {
        contextForm.awardDois = [''];
      }
      if ((contextForm.facilities.length < contextForm.awardDois.length && !contextForm.dataGenerated) || (contextForm.facilityGenerated && contextForm.dataGenerated && contextForm.awardDois.length > 1) || (!contextForm.facilityGenerated && contextForm.dataGenerated)) {
        contextForm.awardDois.splice(i, 1);
      }
    }

    function facilityChange() {
      if (contextForm.awardDois === null || contextForm.awardDois.length < contextForm.facilities.length) {
        addAwardDoi();
      }
      revalidate();
    }

    function facilityGeneratedChange() {
      if (contextForm.facilityGenerated && (contextForm.awardDois === null || contextForm.awardDois.length < 1)) {
        addAwardDoi();
      }
      revalidate();
    }

    watch(
      () => contextForm.award,
      (award) => {
        const awardTypes = Object.values(AwardTypes) as string[];
        if (award && awardTypes.includes(award)) {
          contextForm.otherAward = '';
        }
        revalidate();
      },
    );

    onMounted(() => {
      formRef.value.validate();
    });

    return {
      Definitions,
      facilityEnum,
      formRef,
      contextForm,
      contextFormValid,
      addressFormValid,
      projectAwardValidationRules,
      otherAwardValidationRules,
      doiRequiredRules,
      revalidate,
      addAwardDoi,
      removeAwardDoi,
      facilityChange,
      facilityGeneratedChange,
      canEditSubmissionMetadata,
    };
  },
});
</script>

<template>
  <div>
    <div class="text-h2">
      Submission Context
      <submission-docs-link anchor="submission-context" />
    </div>
    <div class="text-h5">
      Data and sample status
    </div>
    <submission-permission-banner
      v-if="!canEditSubmissionMetadata()"
    />
    <v-form
      ref="formRef"
      v-model="contextFormValid"
      style="max-width: 1000px;"
      class="mb-2"
      :disabled="!canEditSubmissionMetadata()"
    >
      <v-radio-group
        v-model="contextForm.dataGenerated"
        label="Have data already been generated for your study? *"
        :rules="[v => (v === true || v === false) || 'This field is required']"
        @change="revalidate"
      >
        <v-radio
          label="No"
          :value="false"
        />
        <v-radio
          label="Yes"
          :value="true"
        />
      </v-radio-group>
      <v-checkbox
        v-if="contextForm.dataGenerated"
        v-model="contextForm.facilityGenerated"
        label="Data was generated by a DOE user facility"
        hide-details
        class="mb-2 mt-0"
        @change="facilityGeneratedChange"
      />
      <div v-if="contextForm.dataGenerated === false">
        <legend
          class="v-label theme--light mb-2"
          style="font-size: 14px;"
        >
          Are you submitting metadata for samples that will be sent to a DOE user facility?
        </legend>
        <v-checkbox
          v-for="facility in facilityEnum"
          :key="facility"
          v-model="contextForm.facilities"
          :label="facility"
          :value="facility"
          hide-details
          @change="facilityChange"
        />
        <submission-context-shipping-form
          v-if="contextForm.dataGenerated === false && contextForm.facilities.includes('EMSL')"
        />
        <v-radio-group
          v-if="contextForm.dataGenerated === false && contextForm.facilities.length > 0"
          v-model="contextForm.award"
          label="What kind of project have you been awarded? *"
          :rules="projectAwardValidationRules()"
          class="pb-5"
        >
          <div class="d-flex">
            <v-radio
              value="CSP"
              label="CSP"
            />
            <div class="ml-1">
              (<a
                href="https://jgi.doe.gov/user-programs/program-info/csp-overview/csp-annual-call/"
                target="_blank"
                rel="noopener noreferrer"
              >Community Science Program</a>)
            </div>
          </div>

          <div class="d-flex">
            <v-radio
              value="BERSS"
              label="BERSS"
            />
            <div class="ml-1">
              (<a
                href="https://jgi.doe.gov/user-programs/other-programs/"
                target="_blank"
                rel="noopener noreferrer"
              >Biological and Environmental Research Support Science</a>)
            </div>
          </div>

          <div class="d-flex">
            <v-radio
              value="BRCs"
              label="BRCs"
            />
            <div class="ml-1">
              (<a
                href="https://jgi.doe.gov/user-programs/other-programs/"
                target="_blank"
                rel="noopener noreferrer"
              >Bioenergy Research Centers</a>)
            </div>
          </div>

          <div class="d-flex">
            <v-radio
              value="FICUS"
              label="FICUS"
            />
            <div class="ml-1">
              (<a
                href="https://www.emsl.pnnl.gov/basic/ficus-program/1872"
                target="_blank"
                rel="noopener noreferrer"
              >Facilities Integrating Collaborations for User Science</a>)
            </div>
          </div>

          <div class="d-flex">
            <v-radio
              value="MONet"
              label="MONet"
            />
            <div class="ml-1">
              (<a
                href="https://www.emsl.pnnl.gov/monet"
                target="_blank"
                rel="noopener noreferrer"
              >Molecular Observation Network</a>)
            </div>
          </div>

          <v-radio
            :value="contextForm.otherAward"
          >
            <template #label>
              <span class="mr-4">Other</span>
              <v-text-field
                v-model="contextForm.otherAward"
                class="pa-0 ma-0"
                dense
                hide-details
                outlined
                :rules="otherAwardValidationRules()"
              />
            </template>
          </v-radio>
        </v-radio-group>
      </div>
      <div
        v-for="_, i in contextForm.awardDois"
        :key="`awardDoi${i}`"
        class="d-flex"
      >
        <v-card
          v-if="contextForm.dataGenerated || contextForm.facilities.includes('EMSL') || contextForm.facilities.includes('JGI')"
          class="d-flex flex-column grow pa-4 mb-4"
        >
          <div class="d-flex">
            <v-text-field
              v-if="(contextForm.dataGenerated || contextForm.facilities.includes('EMSL') || contextForm.facilities.includes('JGI')) && contextForm.awardDois !== null"
              v-model="contextForm.awardDois[i]"
              :label="`Award DOI ${contextForm.facilityGenerated ? '*' : ''}`"
              :hint="Definitions.doi"
              :rules="doiRequiredRules()"
              persistent-hint
              validate-on-blur
              outlined
              dense
              @change="revalidate"
            >
              <template #message="{ message }">
                <span v-html="message" />
              </template>
            </v-text-field>
          </div>
        </v-card>
        <v-btn
          v-if="(contextForm.dataGenerated || contextForm.facilities.includes('EMSL') || contextForm.facilities.includes('JGI')) && contextForm.awardDois !== null"
          icon
          @click="removeAwardDoi(i)"
        >
          <v-icon>mdi-minus-circle</v-icon>
        </v-btn>
      </div>
      <v-btn
        v-if="contextForm.dataGenerated || contextForm.facilities.includes('EMSL') || contextForm.facilities.includes('JGI')"
        class="mb-4"
        depressed
        @click="addAwardDoi"
      >
        <v-icon class="pr-1">
          mdi-plus-circle
        </v-icon>
        Add Award DOI
      </v-btn>
      <v-checkbox
        v-if="!contextForm.dataGenerated && (contextForm.facilities.includes('EMSL') || contextForm.facilities.includes('JGI'))"
        v-model="contextForm.unknownDOI"
        class="pa-0 ma-0"
        :label="`I don't know my award DOI`"
        :hint="Definitions.unknowndoi"
        persistent-hint
        @change="revalidate"
      />
    </v-form>
    <strong>* indicates required field</strong>
    <div class="d-flex">
      <v-spacer />
      <v-btn
        color="gray"
        depressed
        :to="{ name: 'Study Form' }"
        :disabled="!contextFormValid || (contextForm.facilities.includes('EMSL') && !addressFormValid)"
      >
        Go to next step
        <v-icon class="pl-1">
          mdi-arrow-right-circle
        </v-icon>
      </v-btn>
    </div>
  </div>
</template>
