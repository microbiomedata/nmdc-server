"""Add generic ontology tables and ENVO facet indexes

This migration:
1. Creates new generic ontology_class and ontology_relation tables for future ontology work
2. Adds critical indexes for ENVO facet queries to improve performance from 30+ seconds to <1 second

Revision ID: 43ce041c88cb
Revises: 23ef8096759e
Create Date: 2026-01-21 01:33:58.970768

"""
from typing import Optional

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '43ce041c88cb'
down_revision: Optional[str] = '23ef8096759e'
branch_labels: Optional[str] = None
depends_on: Optional[str] = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ontology_class',
    sa.Column('id', sa.String(), nullable=False),
    sa.Column('type', sa.String(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('definition', sa.Text(), nullable=True),
    sa.Column('alternative_names', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('is_root', sa.Boolean(), nullable=False),
    sa.Column('is_obsolete', sa.Boolean(), nullable=False),
    sa.Column('annotations', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ontology_class'))
    )
    op.create_index(op.f('ix_ontology_class_name'), 'ontology_class', ['name'], unique=False)
    op.create_table('ontology_relation',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('subject', sa.String(), nullable=False),
    sa.Column('predicate', sa.String(), nullable=False),
    sa.Column('object', sa.String(), nullable=False),
    sa.Column('type', sa.String(), nullable=False),
    sa.ForeignKeyConstraint(['subject'], ['ontology_class.id'], name=op.f('fk_ontology_relation_subject_ontology_class')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ontology_relation')),
    sa.UniqueConstraint('subject', 'predicate', 'object', name=op.f('uq_ontology_relation_subject'))
    )
    op.create_index('idx_ontology_relation_object', 'ontology_relation', ['object'], unique=False)
    op.create_index('idx_ontology_relation_predicate', 'ontology_relation', ['predicate'], unique=False)
    op.create_index('idx_ontology_relation_subject', 'ontology_relation', ['subject'], unique=False)

    # Add indexes for ENVO facet queries (critical for performance)
    # These indexes support the facet queries that join biosample -> envo_ancestor -> envo_term
    op.create_index('idx_envo_ancestor_ancestor_id', 'envo_ancestor', ['ancestor_id'], unique=False)
    op.create_index('idx_biosample_env_broad_scale_id', 'biosample', ['env_broad_scale_id'], unique=False)
    op.create_index('idx_biosample_env_local_scale_id', 'biosample', ['env_local_scale_id'], unique=False)
    op.create_index('idx_biosample_env_medium_id', 'biosample', ['env_medium_id'], unique=False)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Drop ENVO facet query indexes
    op.drop_index('idx_biosample_env_medium_id', table_name='biosample')
    op.drop_index('idx_biosample_env_local_scale_id', table_name='biosample')
    op.drop_index('idx_biosample_env_broad_scale_id', table_name='biosample')
    op.drop_index('idx_envo_ancestor_ancestor_id', table_name='envo_ancestor')

    op.drop_index('idx_ontology_relation_subject', table_name='ontology_relation')
    op.drop_index('idx_ontology_relation_predicate', table_name='ontology_relation')
    op.drop_index('idx_ontology_relation_object', table_name='ontology_relation')
    op.drop_table('ontology_relation')
    op.drop_index(op.f('ix_ontology_class_name'), table_name='ontology_class')
    op.drop_table('ontology_class')
    # ### end Alembic commands ###
